<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://unpkg.com; style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://unpkg.com https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com https://cdn.jsdelivr.net; img-src 'self' data: https:; connect-src 'self' https://cdn.jsdelivr.net https://unpkg.com; object-src 'none'; base-uri 'self'; form-action 'self'; frame-ancestors 'none';">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <title>Git Diff - feature</title>
    <script src="https://cdn.jsdelivr.net/npm/diff2html@3.4.47/bundles/js/diff2html.min.js" integrity="sha384-1tVmtFdzvhqVP3vQWJmKYvD0uTtR0r+FhlLWw+vG6F/vNDS7yegNMNNHRS12fSyR" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/diff2html@3.4.47/bundles/css/diff2html.min.css" integrity="sha384-iBvSlI3tNrrSIy7s6mvLg+5B2Z/QXbR4L0Pzg1nRf8zkXrz5JF316MLm2igMIpi2" crossorigin="anonymous" referrerpolicy="no-referrer">
    <style>
/*==============================================================================
 * AUTO-GENERATED - DO NOT EDIT
 *==============================================================================
 * Source: src/core/templates/styles/common.css
 * To edit: Modify source file, then run: src/scripts/sync-skills.sh
 *============================================================================*/

/* Common Styles - Shared across all preview skills */

/* CSS Reset */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

/* Body - Base styles */
body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    line-height: 1.6;
    color: #333;
}

/* Layout: Document (for text-heavy content like markdown) */
.layout-document {
    max-width: 900px;
    margin: 0 auto;
}

.layout-document #content {
    background: white;
    padding: 40px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

/* Layout: Centered (for diagrams, images) */
.layout-centered {
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
}

.layout-centered #content {
    background: white;
    padding: 10px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    max-width: 100%;
}

/* Layout: Full width (for interactive content) */
.layout-full {
    width: 100%;
    height: 100vh;
}

.layout-full #content {
    width: 100%;
    height: 100%;
}

/* Card styling (alternative to content wrapper) */
.card {
    background: white;
    padding: 10px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
        body {
            background: #f6f8fa; margin: 0; padding: 0;
        }
    </style>
</head>
<body>
    <div id="container" class="layout-full">
        <div id="content"></div>
    </div>
    <script>
//==============================================================================
// AUTO-GENERATED - DO NOT EDIT
//==============================================================================
// Source: src/core/templates/scripts/utils.js
// To edit: Modify source file, then run: src/scripts/sync-skills.sh
//==============================================================================

/**
 * Browser Utilities for Preview Skills
 */

/**
 * UTF-8 safe base64 decode
 * Handles Unicode characters properly
 * @param {string} str - Base64 encoded string
 * @returns {string} Decoded UTF-8 string
 */
// eslint-disable-next-line no-unused-vars
function base64DecodeUnicode(str) {
  return decodeURIComponent(
    atob(str)
      .split('')
      .map(function (c) {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
      })
      .join('')
  );
}

/**
 * Get element by ID safely
 * @param {string} id - Element ID
 * @returns {HTMLElement|null} Element or null if not found
 */
function getElement(id) {
  return document.getElementById(id);
}

/**
 * Set element content
 * @param {string} id - Element ID
 * @param {string} content - HTML content to set
 * @deprecated WARNING: This function uses innerHTML and should ONLY be used
 * with trusted/sanitized content. For untrusted content, use textContent
 * or sanitize with DOMPurify first. Consider using setTextContent() instead.
 */
// eslint-disable-next-line no-unused-vars
function setContent(id, content) {
  const element = getElement(id);
  if (element) {
    element.innerHTML = content;
  }
}

/**
 * Set element text content safely (XSS-safe)
 * @param {string} id - Element ID
 * @param {string} text - Plain text content to set
 */
// eslint-disable-next-line no-unused-vars
function setTextContent(id, text) {
  const element = getElement(id);
  if (element) {
    element.textContent = text;
  }
}

//==============================================================================
// AUTO-GENERATED - DO NOT EDIT
//==============================================================================
// Source: src/core/templates/scripts/common-ui.js
// To edit: Modify source file, then run: src/scripts/sync-skills.sh
//==============================================================================

/* eslint-disable no-unused-vars */
// Functions in this file are used by other scripts and HTML onclick handlers

const GITHUB_REPO = 'https://github.com/veelenga/preview-skills';

function initTheme() {
  const savedTheme = localStorage.getItem('theme') || 'light';
  document.documentElement.setAttribute('data-theme', savedTheme);
}

function toggleTheme() {
  const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
  const newTheme = currentTheme === 'light' ? 'dark' : 'light';
  document.documentElement.setAttribute('data-theme', newTheme);
  localStorage.setItem('theme', newTheme);
}

function createHeader(title, stats, toolbarItems = []) {
  const themeToggle = `
        <div class="theme-toggle-wrapper">
            <span class="theme-label">Theme</span>
            <div class="theme-toggle" onclick="toggleTheme()" title="Toggle theme"></div>
        </div>
    `;

  const statsHtml = stats ? `<span class="preview-header-stats">${stats}</span>` : '';
  const toolbarHtml =
    toolbarItems.length > 0 ? `<div class="preview-toolbar">${toolbarItems.join('')}</div>` : '';

  return `
        <div class="preview-header">
            <div class="preview-header-info">
                <strong class="preview-header-title">${title}</strong>
                ${statsHtml}
            </div>
            ${toolbarHtml}
            ${themeToggle}
        </div>
    `;
}

initTheme();

function createSearchBox(onInput, onClear) {
  return `
        <div class="search-box">
            <span class="search-icon">üîç</span>
            <input type="text" class="search-input" placeholder="Search... (Ctrl+F)" oninput="${onInput}">
            <button class="search-clear" onclick="${onClear}">√ó</button>
        </div>
    `;
}

function createButton(label, onclick, icon = '') {
  const iconHtml = icon ? icon + ' ' : '';
  return `<button class="action-btn" onclick="${onclick}">${iconHtml}${label}</button>`;
}

function createFooter() {
  const year = new Date().getFullYear();
  return `
        <div class="preview-footer">
            <div class="footer-links">
                <a href="${GITHUB_REPO}" target="_blank" class="footer-link">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M12 2C6.477 2 2 6.477 2 12c0 4.42 2.865 8.17 6.839 9.49.5.092.682-.217.682-.482 0-.237-.008-.866-.013-1.7-2.782.604-3.369-1.34-3.369-1.34-.454-1.156-1.11-1.464-1.11-1.464-.908-.62.069-.608.069-.608 1.003.07 1.531 1.03 1.531 1.03.892 1.529 2.341 1.087 2.91.831.092-.646.35-1.086.636-1.336-2.22-.253-4.555-1.11-4.555-4.943 0-1.091.39-1.984 1.029-2.683-.103-.253-.446-1.27.098-2.647 0 0 .84-.269 2.75 1.025A9.578 9.578 0 0112 6.836c.85.004 1.705.114 2.504.336 1.909-1.294 2.747-1.025 2.747-1.025.546 1.377.203 2.394.1 2.647.64.699 1.028 1.592 1.028 2.683 0 3.842-2.339 4.687-4.566 4.935.359.309.678.919.678 1.852 0 1.336-.012 2.415-.012 2.743 0 .267.18.578.688.48C19.138 20.167 22 16.418 22 12c0-5.523-4.477-10-10-10z"/>
                    </svg>
                    Source
                </a>
                <a href="${GITHUB_REPO}/blob/main/LICENSE" target="_blank" class="footer-link">
                    <svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3"/>
                    </svg>
                    MIT License
                </a>
            </div>
            <div class="footer-copyright">
                ${year} Preview Skill. Built with <span style="color: #ef4444;">‚ù§</span> by <a href="https://github.com/veelenga" target="_blank" class="footer-author">veelenga</a>
            </div>
        </div>
    `;
}

function showStatus(message) {
  const existing = document.querySelector('.status-message');
  if (existing) existing.remove();

  const statusDiv = document.createElement('div');
  statusDiv.className = 'status-message';
  statusDiv.textContent = message;
  document.body.appendChild(statusDiv);

  setTimeout(() => {
    statusDiv.style.animation = 'slideOut 0.3s ease-in';
    setTimeout(() => statusDiv.remove(), 300);
  }, 2000);
}

function initSearchShortcut(inputSelector) {
  document.addEventListener('keydown', (e) => {
    if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
      e.preventDefault();
      document.querySelector(inputSelector).focus();
    }
  });
}

function copyToClipboard(text, successMessage = 'Copied to clipboard!') {
  navigator.clipboard.writeText(text).then(() => {
    showStatus(successMessage);
  });
}

const encodedDiffData = 'ZGlmZiAtLWdpdCBhL3dlYi9jb21wb25lbnRzL0J1dHRvbi5qc3ggYi93ZWIvY29tcG9uZW50cy9CdXR0b24uanN4Cm5ldyBmaWxlIG1vZGUgMTAwNjQ0CmluZGV4IDAwMDAwMDAuLmEzYjRjNWQKLS0tIC9kZXYvbnVsbAorKysgYi93ZWIvY29tcG9uZW50cy9CdXR0b24uanN4CkBAIC0wLDAgKzEsMzIgQEAKK2ltcG9ydCBSZWFjdCBmcm9tICdyZWFjdCc7CitpbXBvcnQgJy4vQnV0dG9uLmNzcyc7CisKK2V4cG9ydCBmdW5jdGlvbiBCdXR0b24oeworICBjaGlsZHJlbiwKKyAgdmFyaWFudCA9ICdwcmltYXJ5JywKKyAgc2l6ZSA9ICdtZWRpdW0nLAorICBkaXNhYmxlZCA9IGZhbHNlLAorICBvbkNsaWNrCit9KSB7CisgIGNvbnN0IGNsYXNzTmFtZXMgPSBbCisgICAgJ2J0bicsCisgICAgYGJ0bi0tJHt2YXJpYW50fWAsCisgICAgYGJ0bi0tJHtzaXplfWAsCisgICAgZGlzYWJsZWQgJiYgJ2J0bi0tZGlzYWJsZWQnCisgIF0uZmlsdGVyKEJvb2xlYW4pLmpvaW4oJyAnKTsKKworICByZXR1cm4gKAorICAgIDxidXR0b24KKyAgICAgIGNsYXNzTmFtZT17Y2xhc3NOYW1lc30KKyAgICAgIGRpc2FibGVkPXtkaXNhYmxlZH0KKyAgICAgIG9uQ2xpY2s9e29uQ2xpY2t9CisgICAgPgorICAgICAge2NoaWxkcmVufQorICAgIDwvYnV0dG9uPgorICApOworfQorCitCdXR0b24udmFyaWFudHMgPSBbJ3ByaW1hcnknLCAnc2Vjb25kYXJ5JywgJ2RhbmdlciddOworQnV0dG9uLnNpemVzID0gWydzbWFsbCcsICdtZWRpdW0nLCAnbGFyZ2UnXTsKKworZXhwb3J0IGRlZmF1bHQgQnV0dG9uOwoKZGlmZiAtLWdpdCBhL3dlYi9pbmRleC5odG1sIGIvd2ViL2luZGV4Lmh0bWwKaW5kZXggMWEyYjNjNC4uNWQ2ZTdmOCAxMDA2NDQKLS0tIGEvd2ViL2luZGV4Lmh0bWwKKysrIGIvd2ViL2luZGV4Lmh0bWwKQEAgLTMsMTUgKzMsMTkgQEAKIDxoZWFkPgogICAgIDxtZXRhIGNoYXJzZXQ9IlVURi04Ij4KICAgICA8bWV0YSBuYW1lPSJ2aWV3cG9ydCIgY29udGVudD0id2lkdGg9ZGV2aWNlLXdpZHRoLCBpbml0aWFsLXNjYWxlPTEuMCI+Ci0gICAgPHRpdGxlPk15IEFwcDwvdGl0bGU+CisgICAgPHRpdGxlPk15IEFwcCAtIERhc2hib2FyZDwvdGl0bGU+CisgICAgPGxpbmsgcmVsPSJpY29uIiBocmVmPSIvZmF2aWNvbi5pY28iPgorICAgIDxsaW5rIHJlbD0ic3R5bGVzaGVldCIgaHJlZj0iL3N0eWxlcy9tYWluLmNzcyI+CiA8L2hlYWQ+CiA8Ym9keT4KLSAgICA8ZGl2IGlkPSJhcHAiPjwvZGl2PgotICAgIDxzY3JpcHQgc3JjPSJidW5kbGUuanMiPjwvc2NyaXB0PgorICAgIDxkaXYgaWQ9InJvb3QiPjwvZGl2PgorICAgIDxzY3JpcHQgdHlwZT0ibW9kdWxlIiBzcmM9Ii9zcmMvbWFpbi5qc3giPjwvc2NyaXB0PgogPC9ib2R5PgogPC9odG1sPgoKZGlmZiAtLWdpdCBhL2FwaS9oYW5kbGVycy91c2VyLmdvIGIvYXBpL2hhbmRsZXJzL3VzZXIuZ28KaW5kZXggOGY5YTBiMS4uYzJkM2U0ZiAxMDA2NDQKLS0tIGEvYXBpL2hhbmRsZXJzL3VzZXIuZ28KKysrIGIvYXBpL2hhbmRsZXJzL3VzZXIuZ28KQEAgLTEsMzUgKzEsNTIgQEAKIHBhY2thZ2UgaGFuZGxlcnMKCiBpbXBvcnQgKAorCSJjb250ZXh0IgogCSJlbmNvZGluZy9qc29uIgorCSJlcnJvcnMiCiAJIm5ldC9odHRwIgorCSJ0aW1lIgoKIAkiZ2l0aHViLmNvbS9leGFtcGxlL2FwcC9tb2RlbHMiCisJImdpdGh1Yi5jb20vZXhhbXBsZS9hcHAvbWlkZGxld2FyZSIKICkKCit2YXIgRXJyVXNlck5vdEZvdW5kID0gZXJyb3JzLk5ldygidXNlciBub3QgZm91bmQiKQorCiB0eXBlIFVzZXJIYW5kbGVyIHN0cnVjdCB7Ci0JZGIgKkRhdGFiYXNlCisJZGIgICAgICpEYXRhYmFzZQorCWNhY2hlICAqQ2FjaGUKKwlsb2dnZXIgKkxvZ2dlcgogfQoKLWZ1bmMgKGggKlVzZXJIYW5kbGVyKSBHZXRVc2VyKHcgaHR0cC5SZXNwb25zZVdyaXRlciwgciAqaHR0cC5SZXF1ZXN0KSB7Ci0JaWQgOj0gci5VUkwuUXVlcnkoKS5HZXQoImlkIikKLQotCXVzZXIsIGVyciA6PSBoLmRiLkZpbmRVc2VyKGlkKQorZnVuYyAoaCAqVXNlckhhbmRsZXIpIEdldFVzZXIodyBodHRwLlJlc3BvbnNlV3JpdGVyLCByICpodHRwLlJlcXVlc3QpIGVycm9yIHsKKwljdHgsIGNhbmNlbCA6PSBjb250ZXh0LldpdGhUaW1lb3V0KHIuQ29udGV4dCgpLCA1KnRpbWUuU2Vjb25kKQorCWRlZmVyIGNhbmNlbCgpCisKKwl1c2VySUQgOj0gbWlkZGxld2FyZS5HZXRVc2VySUQocikKKwlpZiB1c2VySUQgPT0gIiIgeworCQlyZXR1cm4gRXJyVXNlck5vdEZvdW5kCisJfQorCisJLy8gVHJ5IGNhY2hlIGZpcnN0CisJaWYgY2FjaGVkLCBvayA6PSBoLmNhY2hlLkdldCh1c2VySUQpOyBvayB7CisJCXJldHVybiBqc29uLk5ld0VuY29kZXIodykuRW5jb2RlKGNhY2hlZCkKKwl9CisKKwl1c2VyLCBlcnIgOj0gaC5kYi5GaW5kVXNlcldpdGhDb250ZXh0KGN0eCwgdXNlcklEKQogCWlmIGVyciAhPSBuaWwgewotCQlodHRwLkVycm9yKHcsICJVc2VyIG5vdCBmb3VuZCIsIDQwNCkKLQkJcmV0dXJuCisJCWgubG9nZ2VyLkVycm9yKCJmYWlsZWQgdG8gZmluZCB1c2VyIiwgImlkIiwgdXNlcklELCAiZXJyb3IiLCBlcnIpCisJCXJldHVybiBFcnJVc2VyTm90Rm91bmQKIAl9Ci0KLQlqc29uLk5ld0VuY29kZXIodykuRW5jb2RlKHVzZXIpCisKKwloLmNhY2hlLlNldCh1c2VySUQsIHVzZXIsIDUqdGltZS5NaW51dGUpCisJcmV0dXJuIGpzb24uTmV3RW5jb2Rlcih3KS5FbmNvZGUodXNlcikKIH0KCmRpZmYgLS1naXQgYS93ZWIvbGVnYWN5L29sZC11dGlscy5qc3ggYi93ZWIvbGVnYWN5L29sZC11dGlscy5qc3gKZGVsZXRlZCBmaWxlIG1vZGUgMTAwNjQ0CmluZGV4IDlhOGI3YzYuLjAwMDAwMDAKLS0tIGEvd2ViL2xlZ2FjeS9vbGQtdXRpbHMuanN4CisrKyAvZGV2L251bGwKQEAgLTEsMjUgKzAsMCBAQAotLy8gTGVnYWN5IHV0aWxpdGllcyAtIERPIE5PVCBVU0UKLS8vIERlcHJlY2F0ZWQgc2luY2UgdjIuMAotCi1leHBvcnQgZnVuY3Rpb24gZm9ybWF0RGF0ZShkYXRlKSB7Ci0gIHJldHVybiBkYXRlLnRvU3RyaW5nKCk7Ci19Ci0KLWV4cG9ydCBmdW5jdGlvbiBwYXJzZVF1ZXJ5KHN0cikgewotICBjb25zdCBwYXJhbXMgPSB7fTsKLSAgc3RyLnNwbGl0KCcmJykuZm9yRWFjaChwYWlyID0+IHsKLSAgICBjb25zdCBba2V5LCB2YWxdID0gcGFpci5zcGxpdCgnPScpOwotICAgIHBhcmFtc1trZXldID0gdmFsOwotICB9KTsKLSAgcmV0dXJuIHBhcmFtczsKLX0KLQotZXhwb3J0IGZ1bmN0aW9uIGRlYm91bmNlKGZuLCBkZWxheSkgewotICBsZXQgdGltZXI7Ci0gIHJldHVybiBmdW5jdGlvbiguLi5hcmdzKSB7Ci0gICAgY2xlYXJUaW1lb3V0KHRpbWVyKTsKLSAgICB0aW1lciA9IHNldFRpbWVvdXQoKCkgPT4gZm4uYXBwbHkodGhpcywgYXJncyksIGRlbGF5KTsKLSAgfTsKLX0KLQotZXhwb3J0IGRlZmF1bHQgeyBmb3JtYXREYXRlLCBwYXJzZVF1ZXJ5LCBkZWJvdW5jZSB9Owo=';

const VIEW_MODES = {
  SIDE_BY_SIDE: 'side-by-side',
  LINE_BY_LINE: 'line-by-line',
};

const STORAGE_KEY = 'diff-view-mode';
const DEFAULT_VIEW_MODE = VIEW_MODES.LINE_BY_LINE;

const LINE_TYPES = {
  INSERT: 'insert',
  DELETE: 'delete',
};

const COLLAPSE_ICONS = {
  EXPANDED: '‚ñº',
  COLLAPSED: '‚ñ∂',
};

const DEFAULT_FILE_INDEX_TO_EXPAND = 1;

window.addEventListener('load', function () {
  const container = document.getElementById('container');
  const targetElement = document.getElementById('content');

  let currentViewMode = loadViewMode();
  let parsedDiff = null;
  let currentFilter = '';

  function loadViewMode() {
    const saved = localStorage.getItem(STORAGE_KEY);
    return saved && Object.values(VIEW_MODES).includes(saved) ? saved : DEFAULT_VIEW_MODE;
  }

  function saveViewMode(mode) {
    localStorage.setItem(STORAGE_KEY, mode);
  }

  function calculateStats(parsed) {
    let additions = 0;
    let deletions = 0;
    const files = parsed.length;

    parsed.forEach((file) => {
      file.blocks.forEach((block) => {
        block.lines.forEach((line) => {
          if (line.type === LINE_TYPES.INSERT) additions++;
          if (line.type === LINE_TYPES.DELETE) deletions++;
        });
      });
    });

    return { files, additions, deletions };
  }

  function createHeader(stats) {
    const header = document.createElement('div');
    header.style.cssText =
      'background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 24px 32px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px;';

    header.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;">
                <div>
                    <h1 style="margin: 0 0 8px 0; font-size: 24px; font-weight: 600;">Git Changes Preview</h1>
                    <div style="display: flex; gap: 20px; font-size: 14px; opacity: 0.95;">
                        <span><strong>${stats.files}</strong> ${stats.files === 1 ? 'file' : 'files'} changed</span>
                        <span style="color: #7bed9f;"><strong>+${stats.additions}</strong> additions</span>
                        <span style="color: #ff6b6b;"><strong>-${stats.deletions}</strong> deletions</span>
                    </div>
                </div>
                <div style="display: flex; gap: 12px; align-items: center;" id="controls"></div>
            </div>
        `;

    return header;
  }

  function createSearchBox() {
    const searchContainer = document.createElement('div');
    searchContainer.style.cssText = 'position: relative;';

    const searchInput = document.createElement('input');
    searchInput.type = 'text';
    searchInput.placeholder = 'Search files...';
    searchInput.style.cssText =
      'padding: 8px 36px 8px 12px; border: 1px solid rgba(255,255,255,0.3); border-radius: 6px; background: rgba(255,255,255,0.15); color: white; font-size: 14px; width: 200px; outline: none;';
    searchInput.style.setProperty('::placeholder', 'color: rgba(255,255,255,0.7);');

    const searchIcon = document.createElement('span');
    searchIcon.innerHTML = 'üîç';
    searchIcon.style.cssText =
      'position: absolute; right: 10px; top: 50%; transform: translateY(-50%); pointer-events: none; opacity: 0.8;';

    searchInput.addEventListener('input', function (e) {
      currentFilter = e.target.value.toLowerCase();
      filterFiles();
    });

    searchContainer.appendChild(searchInput);
    searchContainer.appendChild(searchIcon);

    return searchContainer;
  }

  function createExpandCollapseButton() {
    const btn = document.createElement('button');
    btn.textContent = 'Expand All';
    btn.id = 'expand-collapse-btn';
    btn.style.cssText =
      'padding: 8px 16px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.15); cursor: pointer; font-size: 14px; color: white; border-radius: 6px; transition: all 0.2s;';

    btn.addEventListener('click', function () {
      const allFiles = Array.from(document.querySelectorAll('.d2h-file-wrapper'));
      const allExpanded = allFiles.every((el) => !el.classList.contains('collapsed'));

      if (allExpanded) {
        allFiles.forEach((el) => collapseFile(el));
        btn.textContent = 'Expand All';
      } else {
        allFiles.forEach((el) => expandFile(el));
        btn.textContent = 'Collapse All';
      }
    });

    btn.addEventListener('mouseenter', function () {
      btn.style.background = 'rgba(255,255,255,0.25)';
    });

    btn.addEventListener('mouseleave', function () {
      btn.style.background = 'rgba(255,255,255,0.15)';
    });

    return btn;
  }

  function createViewToggle() {
    const toggleContainer = document.createElement('div');
    toggleContainer.style.cssText =
      'background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.3); border-radius: 6px; display: flex;';

    const sideBySideBtn = createButton('Split View', VIEW_MODES.SIDE_BY_SIDE);
    const lineByLineBtn = createButton('Unified', VIEW_MODES.LINE_BY_LINE);

    toggleContainer.appendChild(sideBySideBtn);
    toggleContainer.appendChild(lineByLineBtn);

    return { container: toggleContainer, sideBySideBtn, lineByLineBtn };
  }

  function createButton(text, mode) {
    const btn = document.createElement('button');
    btn.textContent = text;
    btn.style.cssText =
      'padding: 8px 16px; border: none; background: transparent; cursor: pointer; font-size: 14px; color: white; transition: all 0.2s;';

    btn.addEventListener('click', function () {
      if (currentViewMode !== mode) {
        currentViewMode = mode;
        saveViewMode(currentViewMode);
        updateButtonStates();
        renderDiff();
      }
    });

    btn.addEventListener('mouseenter', function () {
      if (currentViewMode !== mode) {
        btn.style.background = 'rgba(255,255,255,0.1)';
      }
    });

    btn.addEventListener('mouseleave', function () {
      if (currentViewMode !== mode) {
        btn.style.background = 'transparent';
      }
    });

    return btn;
  }

  let viewToggleButtons = null;

  function updateButtonStates() {
    if (!viewToggleButtons) return;

    const { sideBySideBtn, lineByLineBtn } = viewToggleButtons;

    if (currentViewMode === VIEW_MODES.SIDE_BY_SIDE) {
      sideBySideBtn.style.background = 'rgba(255,255,255,0.25)';
      sideBySideBtn.style.fontWeight = '600';
      lineByLineBtn.style.background = 'transparent';
      lineByLineBtn.style.fontWeight = 'normal';
    } else {
      sideBySideBtn.style.background = 'transparent';
      sideBySideBtn.style.fontWeight = 'normal';
      lineByLineBtn.style.background = 'rgba(255,255,255,0.25)';
      lineByLineBtn.style.fontWeight = '600';
    }
  }

  function expandFile(fileWrapper) {
    fileWrapper.classList.remove('collapsed');
    const header = fileWrapper.querySelector('.d2h-file-header');

    let sibling = header ? header.nextElementSibling : null;
    while (sibling) {
      sibling.style.display = '';
      sibling = sibling.nextElementSibling;
    }

    const icon = fileWrapper.querySelector('.collapse-icon');
    if (icon) {
      icon.textContent = COLLAPSE_ICONS.EXPANDED;
    }
  }

  function collapseFile(fileWrapper) {
    fileWrapper.classList.add('collapsed');
    const header = fileWrapper.querySelector('.d2h-file-header');

    let sibling = header ? header.nextElementSibling : null;
    while (sibling) {
      sibling.style.display = 'none';
      sibling = sibling.nextElementSibling;
    }

    const icon = fileWrapper.querySelector('.collapse-icon');
    if (icon) {
      icon.textContent = COLLAPSE_ICONS.COLLAPSED;
    }
  }

  function toggleFile(fileWrapper) {
    if (fileWrapper.classList.contains('collapsed')) {
      expandFile(fileWrapper);
    } else {
      collapseFile(fileWrapper);
    }
    updateExpandCollapseButton();
  }

  function updateExpandCollapseButton() {
    const btn = document.getElementById('expand-collapse-btn');
    if (!btn) return;

    const allFiles = Array.from(document.querySelectorAll('.d2h-file-wrapper'));
    const visibleFiles = allFiles.filter((el) => el.style.display !== 'none');
    const allExpanded = visibleFiles.every((el) => !el.classList.contains('collapsed'));

    btn.textContent = allExpanded ? 'Collapse All' : 'Expand All';
  }

  function makeFilesCollapsible() {
    document.querySelectorAll('.d2h-file-wrapper').forEach((fileWrapper, index) => {
      const header = fileWrapper.querySelector('.d2h-file-header');
      if (!header) return;

      header.style.cursor = 'pointer';
      header.style.userSelect = 'none';

      const icon = document.createElement('span');
      icon.className = 'collapse-icon';
      icon.textContent = COLLAPSE_ICONS.EXPANDED;
      icon.style.cssText =
        'margin-right: 8px; font-size: 12px; transition: transform 0.2s; display: inline-block;';

      const nameSpan = header.querySelector('.d2h-file-name-wrapper, .d2h-file-name');
      if (nameSpan) {
        nameSpan.insertBefore(icon, nameSpan.firstChild);
      }

      header.addEventListener('click', function (e) {
        if (e.target.tagName === 'A') return;
        toggleFile(fileWrapper);
      });

      if (index >= DEFAULT_FILE_INDEX_TO_EXPAND) {
        collapseFile(fileWrapper);
      }
    });

    updateExpandCollapseButton();
  }

  function filterFiles() {
    if (!currentFilter) {
      document.querySelectorAll('.d2h-file-wrapper').forEach((el) => {
        el.style.display = '';
      });
      updateExpandCollapseButton();
      return;
    }

    document.querySelectorAll('.d2h-file-wrapper').forEach((el) => {
      const fileName = el.querySelector('.d2h-file-name');
      if (fileName) {
        const name = fileName.textContent.toLowerCase();
        const isVisible = name.includes(currentFilter);
        el.style.display = isVisible ? '' : 'none';
        if (isVisible) {
          expandFile(el);
        }
      }
    });

    updateExpandCollapseButton();
  }

  function enhanceDiffUI() {
    const style = document.createElement('style');
    style.textContent = `
            html {
                scroll-behavior: smooth;
            }
            .d2h-wrapper {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif !important;
            }
            .d2h-file-header {
                background: linear-gradient(to right, #f6f8fa, #ffffff) !important;
                border-bottom: 2px solid #e1e4e8 !important;
                padding: 12px 16px !important;
                transition: background 0.2s !important;
            }
            .d2h-file-header:hover {
                background: linear-gradient(to right, #eef1f5, #f6f8fa) !important;
            }
            .d2h-file-name {
                font-weight: 600 !important;
                font-size: 14px !important;
                color: #24292e !important;
            }
            .d2h-file-wrapper.collapsed .d2h-file-header {
                border-bottom: none !important;
            }
            .d2h-file-stats {
                font-size: 13px !important;
                color: #586069 !important;
            }
            .d2h-code-line {
                font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace !important;
                font-size: 13px !important;
                line-height: 20px !important;
            }
            .d2h-code-line-ctn {
                padding: 0 8px !important;
            }
            .d2h-file-wrapper {
                border: 1px solid #e1e4e8 !important;
                border-radius: 8px !important;
                margin-bottom: 16px !important;
                overflow: hidden !important;
                box-shadow: 0 1px 3px rgba(0,0,0,0.04) !important;
                transition: box-shadow 0.2s, background 0.6s !important;
                scroll-margin-top: 140px !important;
            }
            .d2h-file-wrapper:hover {
                box-shadow: 0 2px 8px rgba(0,0,0,0.08) !important;
            }
            .d2h-ins {
                background: #e6ffed !important;
            }
            .d2h-del {
                background: #ffeef0 !important;
            }
            .d2h-code-line-prefix {
                opacity: 0.6 !important;
            }
            .d2h-file-list-wrapper {
                display: none !important;
            }
            input::placeholder {
                color: rgba(255,255,255,0.7) !important;
            }
        `;
    document.head.appendChild(style);
  }

  function renderDiff() {
    try {
      if (!parsedDiff) {
        const diffData = base64DecodeUnicode(encodedDiffData);

        if (!diffData || diffData.trim().length === 0) {
          targetElement.innerHTML = `
                        <div class="no-changes" style="text-align: center; padding: 80px 40px; color: #586069;">
                            <div style="font-size: 64px; margin-bottom: 20px;">‚úì</div>
                            <h2 style="margin: 0 0 12px 0; font-size: 24px; font-weight: 600; color: #24292e;">No changes detected</h2>
                            <p style="margin: 0; font-size: 16px; color: #586069;">Your working directory is clean</p>
                        </div>
                    `;
          return;
        }

        if (typeof Diff2Html === 'undefined') {
          targetElement.innerHTML = `
                        <div style="max-width: 600px; margin: 60px auto; padding: 32px; background: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                            <div style="font-size: 48px; text-align: center; margin-bottom: 20px;">‚ö†Ô∏è</div>
                            <h2 style="margin: 0 0 16px 0; font-size: 20px; font-weight: 600; color: #d73a49; text-align: center;">Library Loading Failed</h2>
                            <p style="margin: 0 0 20px 0; color: #586069; text-align: center;">The diff2html library couldn't be loaded from the CDN.</p>
                            <div style="background: #f6f8fa; padding: 16px; border-radius: 6px;">
                                <p style="margin: 0 0 8px 0; font-weight: 600; color: #24292e;">Possible causes:</p>
                                <ul style="margin: 0; padding-left: 24px; color: #586069;">
                                    <li>No internet connection</li>
                                    <li>CDN is blocked or unavailable</li>
                                    <li>Firewall or ad blocker interference</li>
                                </ul>
                            </div>
                        </div>
                    `;
          return;
        }

        parsedDiff = Diff2Html.parse(diffData);

        const stats = calculateStats(parsedDiff);
        const header = createHeader(stats);
        container.insertBefore(header, targetElement);

        const controlsContainer = document.getElementById('controls');
        const expandCollapseBtn = createExpandCollapseButton();
        const searchBox = createSearchBox();
        const viewToggle = createViewToggle();

        viewToggleButtons = {
          sideBySideBtn: viewToggle.sideBySideBtn,
          lineByLineBtn: viewToggle.lineByLineBtn,
        };

        controlsContainer.appendChild(expandCollapseBtn);
        controlsContainer.appendChild(searchBox);
        controlsContainer.appendChild(viewToggle.container);

        updateButtonStates();
        enhanceDiffUI();
      }

      const diffHtml = Diff2Html.html(parsedDiff, {
        drawFileList: false,
        matching: 'lines',
        outputFormat: currentViewMode,
        renderNothingWhenEmpty: false,
      });

      targetElement.innerHTML = diffHtml;
      makeFilesCollapsible();
      filterFiles();
    } catch (error) {
      targetElement.innerHTML = `
                <div style="max-width: 600px; margin: 60px auto; padding: 32px; background: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                    <div style="font-size: 48px; text-align: center; margin-bottom: 20px;">‚ùå</div>
                    <h2 style="margin: 0 0 16px 0; font-size: 20px; font-weight: 600; color: #d73a49; text-align: center;">Rendering Error</h2>
                    <p style="margin: 0 0 20px 0; color: #24292e; text-align: center;"><strong>${error.message}</strong></p>
                    <details style="margin-top: 20px;">
                        <summary style="cursor: pointer; color: #0366d6; font-weight: 600; margin-bottom: 12px;">Show stack trace</summary>
                        <pre style="margin: 0; padding: 16px; background: #f6f8fa; border-radius: 6px; overflow-x: auto; font-size: 12px; color: #24292e; white-space: pre-wrap;">${error.stack || 'No stack trace available'}</pre>
                    </details>
                </div>
            `;
    }
  }

  renderDiff();
});
    </script>
</body>
</html>
